# Motion Mavericks Fast - Context & Architecture Overview

## Project Purpose
Motion Mavericks Fast is a secure, fast, and user-friendly web application for clients to upload large video and post-production files. It is inspired by Red Bull Fast, with a modern dark mode UI built with Next.js 15+ (TypeScript), Mantine Core, and @mantine/ui prebuilt components. The system is designed for video content production workflows, supporting large file uploads, secure access, and automated notifications.

## Key Concepts
- **Unique Upload Links**: Each client/project receives a unique, expiring upload link generated by the admin. No login is required for clients.
- **Admin Portal**: Admins can create/manage links, view uploads, and configure service connections (storage, email, etc.) after an initial setup.
- **Initial Setup Flow**: A guided process for the first-time administrator to configure the application (create admin user, set up database, Wasabi storage, and email service) with real-time validation.
- **File Type Restrictions**: Only approved post-production file types are allowed for upload including video, audio, images, PDFs, and production project files.
- **Notifications**: Both admins and clients receive email notifications upon successful uploads, implemented through the SendGrid email service.
- **Security**: Strict file validation, HTTPS, expiring links, and comprehensive error handling are enforced.
- **File Storage**: Multi-tier storage across Cloudflare R2, Wasabi, and LucidLink with intelligent lifecycle management.
- **Large File Handling**: Resumable uploads with chunking for reliable transfer of large production files.
- **Video Processing**: Custom video transcoding pipeline using Cloudflare Workers and Digital Ocean GPU instances.

## High-Level Architecture
- **Framework**: Next.js 15+ with TypeScript.
    - **UI**: React with Mantine Core and @mantine/ui prebuilt components (dark mode, mobile-first), utilizing the Next.js App Router (`app/` directory for pages, layouts, and components).
    - **Backend Logic**: Next.js API Routes (`app/api/` directory) for handling authentication, link generation and management, file uploads, notifications, and settings.
- **Database**: MongoDB with Mongoose ODM.
    - Flexible database configuration through setup wizard
    - Connection testing and validation before setup completion
    - Models for `User`, `UploadLink`, and `File` with proper relationships
- **Storage**: Multi-tier storage architecture:
    - **Cloudflare R2**: Edge-optimized storage for frequently accessed proxies
    - **Wasabi Cloud Storage**: Long-term archival for all files
    - **LucidLink**: High-performance filesystem access for post-production
- **Email**: SendGrid for notifications.
    - Configurable sender and admin email addresses
    - HTML and plain text email templates
    - Success/failure notifications for both admins and clients
- **File Upload**: Integrated Resumable.js.
    - Chunked upload capability for large files
    - Pause/resume functionality
    - Progress tracking and error handling
    - Togglable between standard and resumable uploads
- **Video Processing**: Cloudflare Worker with Digital Ocean integration.
    - On-demand GPU instances for video transcoding
    - Multiple quality levels (360p, 540p, 720p, 1080p, 2160p)
    - Automatic proxy generation and delivery
    - Intelligent lifecycle management for optimized storage costs
    - R2 storage for high-performance video delivery
    - Edge-optimized streaming for global audiences

## Application Flow
1. **Initial Setup**:
   - Administrator completes setup wizard or uses initialization script
   - Database, storage, and email services are configured
   - Admin user is created

2. **Admin Operations**:
   - Admin creates upload links for clients/projects
   - Admin manages existing links (enable/disable, delete)
   - Admin views uploaded files and their status
   - Admin configures system settings

3. **Client Upload**:
   - Client receives unique upload link
   - Client uploads files through user-friendly interface
   - System validates, processes, and stores files
   - Notifications are sent to admin and optionally client

4. **File Management**:
   - Admins can view, download, and delete uploaded files
   - Files are securely stored in Wasabi cloud storage
   - File metadata is tracked in the database

5. **Video Processing**:
   - Videos are automatically detected and sent to the Cloudflare Worker
   - Worker creates a Digital Ocean GPU instance for transcoding
   - Multiple quality proxies are generated (360p through 2160p as needed)
   - Proxies are stored in R2 for edge delivery and Wasabi for archival
   - Adaptive delivery based on user's connection speed and device capabilities

## Technical Implementation

### Database Schema
The application uses MongoDB with three primary models:
1. **User** - Administrators with authentication credentials
2. **UploadLink** - Client upload links with metadata
3. **File** - Uploaded file records with references to links

### API Structure
The application uses Next.js API routes organized by functionality:
- `/api/setup/*` - Initial configuration endpoints
- `/api/auth/*` - Authentication endpoints
- `/api/links/*` - Upload link management
- `/api/upload/*` - File upload handling (including chunked uploads)
- `/api/files/*` - File management and retrieval
- `/api/files/[fileId]/transcode` - Video transcoding initiation
- `/api/files/playback` - Adaptive video playback endpoints

### Video Processing Worker
- **Cloudflare Worker**: Central orchestration point for video processing at `video.motionmavericks.com.au`
- **Digital Ocean Integration**: On-demand GPU instances for efficient video transcoding
- **Endpoints**:
  - `/api/transcode` - Start transcoding process
  - `/api/status/:jobId` - Check transcoding status
  - `/proxy/:fileId/:quality` - Serve video proxy with quality selection
  - `/api/upload` - Generate pre-signed upload URLs
  - `/api/webhook` - Handle transcoding completion notifications
  - `/api/lifecycle` - Run lifecycle maintenance
  - `/api/health` - Health check endpoint

### Frontend Components
- Built with Mantine UI for a consistent, modern interface
- Responsive design for desktop and mobile use
- Dark mode theme throughout the application
- Clear user feedback and error handling
- Adaptive video player with quality selection

## Deployment & Configuration
- All configuration is stored in `.env.local` (not committed to version control)
- Setup wizard guides initial configuration interactively
- Environment variables can be set manually for deployment platforms
- Multiple initialization options are available:
  - Interactive setup wizard through the UI
  - `init-admin` script for automated setup with default settings
  - `create-admin` script for direct admin user creation with custom credentials
- Required environment variables:
  - `MONGODB_URI`: MongoDB connection string
  - `JWT_SECRET`: Secret key for JSON Web Token authentication
  - `WASABI_ACCESS_KEY_ID`, `WASABI_SECRET_ACCESS_KEY`, `WASABI_BUCKET_NAME`, `WASABI_REGION`, `WASABI_ENDPOINT`: Wasabi storage configuration
  - `SENDGRID_API_KEY`, `SENDER_EMAIL`, `ADMIN_EMAILS`: Email notification configuration
  - `CLOUDFLARE_WORKER_URL`: URL to the Cloudflare Worker for video processing
  - `CLOUDFLARE_API_SECRET`: Secret key for Worker API authentication
  - `DIGITAL_OCEAN_TOKEN`: API token for Digital Ocean integration
  - `DO_SSH_KEY_IDS`: SSH key IDs for secure instance access
  - `R2_ACCESS_KEY_ID`, `R2_SECRET_ACCESS_KEY`, `R2_BUCKET_NAME`, `R2_ENDPOINT`: Credentials for R2 storage

## Extensibility & Handover
- All configuration is managed via the initial setup flow and admin settings
- The entire application is contained within the Next.js project structure
- Documentation is maintained in the `docs/` folder
- Clear error handling and graceful degradation when services are unavailable

## Onboarding for New Developers
1. Review the documentation in the `docs/` folder
2. Understand the Next.js App Router structure
3. Set up the required services (MongoDB, Wasabi, SendGrid, Cloudflare, Digital Ocean)
4. Run the application with `npm run dev` and complete the setup flow
5. Follow coding standards in the `.cursorrules` file

## Security Considerations
- All user inputs are validated on both client and server
- File types are restricted and validated
- Authentication uses industry-standard JWT
- Storage access is controlled via secure credentials
- Database access is restricted by authentication
- All API endpoints have proper authorization checks
- Worker API secured with API tokens and secrets